# Obsidian互換モード（解決規則メモ）

この文書は、Obsidianの挙動調査に基づく「互換モード」の解決規則をまとめる。
mdhopの厳密モード（曖昧時エラー）とは別のルールである。

## 前提と目的

- 互換モードは「曖昧でも解決を進める」ためのモード。
- 観測結果に基づく仕様であり、将来の検証で更新される可能性がある。

## 同一扱い

- `[[B]]` と `[B](B.md)` は同一の解決規則で扱う。
- `[[sub/B]]` と `[B](sub/B.md)` も同一。

## 解決規則（互換モード）

1. **同一ディレクトリ優先**
   - `from` と同じディレクトリに `B.md` があれば必ずそれを解決先とする。
2. **basename解決（フォールバック）**
   - 同一ディレクトリに存在しない場合、Vault全体から basename=`B` の候補を集める。
3. **最短パス優先**
   - 候補が複数ある場合、**パス文字列の長さが最短**のものを優先する。
4. **辞書順タイブレーク**
   - 文字列長が同じ場合は **パス文字列の辞書順**で最小のものを選ぶ。

## 既知の観測結果

- `sub1/B.md` と `sub3/B.md` がある場合、別ディレクトリからの `[[B]]` は `sub1/B.md` が選ばれた。
- `sub1` を `z` に改名すると選択先が `z/B.md` に切り替わった。
- `sub3` を `z` に改名すると選択先は `sub1/B.md` のままだった。

## 未検証/除外

- 大文字小文字の差（`sub1` vs `Sub1`）は、検証環境で作れなかったため未検証。

---

## 互換モードのストーリー

### C1. 曖昧リンクの解決（互換モード）

- 状況: basename が複数あり、`[[B]]` / `[B](B.md)` が曖昧
- 手順:
  1) 互換モードを有効にする（将来追加）
  2) `mdhop resolve --vault . --from Notes/A.md --link '[[B]]'`
- 期待結果:
  - 同一ディレクトリ優先、なければ最短パス→辞書順で解決される

### C2. 互換モードの事後解消

- 状況: 互換モードで曖昧を許容したが、厳密モードへ戻したい
- 手順:
  1) `mdhop disambiguate --name B --target sub1/B.md --scan`
  2) `mdhop build --vault .`
- 期待結果:
  - 曖昧リンクが一意化され、厳密モードの build が通る
